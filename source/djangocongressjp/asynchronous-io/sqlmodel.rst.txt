SQLModel
======================================================================

SQLAlchemy + Pydantic + ä½œè€…tiangoloæ°ã®å·¥å¤«

https://sqlmodel.tiangolo.com/features/

é€Ÿç¿’SQLModelğŸƒâ€â™‚ï¸ (PyCon JP 2024)
--------------------------------------------------

.. raw:: html

    <iframe width="560" height="315" src="https://www.youtube.com/embed/x7qCG9RP7u4?si=_cwx2RHSBf0CZkxL" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

`ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« <https://sqlmodel.tiangolo.com/tutorial/>`__ ã®å†…å®¹ã‚’30åˆ†ã§ã‚«ãƒãƒ¼ã—ã¦ã¾ã™

ã“ã“ã§ã‚‚Pydantic
--------------------------------------------------

* ``SQLModel`` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã¯ã€Pydanticã® ``BaseModel`` ã§ã‚‚ã‚ã‚‹ã®ã§ã€ **FastAPIã§ä½¿ãˆã‚‹**
* ORMã‚’æ‰±ã†éš›ã«ã‚‚ã‚¨ãƒ‡ã‚£ã‚¿ã§è£œå®ŒãŒåŠ¹ã

SQLAlchemy
--------------------------------------------------

* https://github.com/sqlalchemy/sqlalchemy
* ä»£è¡¨çš„ãªORM
* **DBã®éåŒæœŸIO** ã‚’ã‚µãƒãƒ¼ãƒˆï¼ï¼ˆã‚ã‚ŠãŒã¨ã†ï¼ï¼ï¼‰

DBã®éåŒæœŸIO
======================================================================

* **SQLAlchemy** ã«SQLModelã¯ä¹—ã£ã‹ã‚‹ï¼ˆSQLAlchemyã®è©±ã«ãªã‚Šã¾ã™ï¼‰
* PostgreSQLã®ä¾‹

SQLModelã¨ã—ã¦
--------------------------------------------------

.. code-block:: python

    from sqlalchemy.ext.asyncio import create_async_engine
    from sqlmodel.ext.asyncio.session import AsyncSession

    database_url = "postgresql+asyncpg://developer:mysecretpassword@127.0.0.1:5432/practice"
    engine = create_async_engine(database_url)
    async with AsyncSession(engine) as session:
        ...

IMOï¼š ``async_sessionmaker`` ã¨ã„ã„ã¨ã“å–ã‚Š
--------------------------------------------------

.. code-block:: python

    from sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine
    from sqlmodel.ext.asyncio.session import AsyncSession as SQLModelAsyncSession

    database_url = "postgresql+asyncpg://developer:mysecretpassword@127.0.0.1:5432/practice"
    engine = create_async_engine(database_url)
    AsyncSession = async_sessionmaker(engine, class_=SQLModelAsyncSession)
    async with AsyncSession() as session:  # AsyncSession.begin() ã‚‚ã§ãã‚‹
        ...

SQLModelãŒæä¾›ã™ã‚‹DBã‚»ãƒƒã‚·ãƒ§ãƒ³
--------------------------------------------------

.. code-block:: python

    from sqlmodel import Session
    from sqlmodel.ext.asyncio.session import AsyncSession

* **DBã¨ã®ã‚„ã‚Šå–ã‚Š** ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é€šã—ã¦
* SQLAlchemyã® ``Session`` ã‚„ ``AsyncSession`` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹

DBã‚»ãƒƒã‚·ãƒ§ãƒ³æ¯”è¼ƒ
--------------------------------------------------

.. list-table::

    * - ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
      - ``execute()`` 
      - ``exec()``
    * - SQLAlchemy
      - **ã‚ã‚‹**
      - ãªã„
    * - SQLModel
      - ã‚ã‚‹
      - **ã‚ã‚‹** ï¼ˆæ¨å¥¨ï¼‰

SQLModelã®DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ **å‹ãŒå½“ãŸã‚‹**
--------------------------------------------------

* ``Session`` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« ``statement`` ã‚’æ¸¡ã—ã¦ã€ ``exec()`` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶

.. code-block:: python
    :emphasize-lines: 3

    statement = select(Hero)
    async with AsyncSession(async_engine) as session:
        results = await session.exec(statement)
        for hero in results:
            print(repr(hero))

* SQLAlchemyã®Sessionã® ``execute().scalars()`` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§å®Ÿç¾ğŸƒâ€â™‚ï¸

``sessionmaker`` ã®æä¾›
--------------------------------------------------

:SQLAlchemy: ã‚ã‚‹ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® **ãƒ•ã‚¡ã‚¯ãƒˆãƒª** ã‚¯ãƒ©ã‚¹ã‚’è¿”ã™ãŸã‚ã€å¸¸ã« ``engine`` ã‚’æ¸¡ã—ã¦åˆæœŸåŒ–ã—ãªãã¦ã‚ˆããªã‚‹
:SQLModel: ãªã„ã€‚`tiangoloæ° <https://github.com/fastapi/sqlmodel/issues/75#issuecomment-1311796665>`__ ã€Œå¸¸ã« ``with Session(engine)`` ã™ã‚Œã°ã‚ˆã„ã€ï¼ˆIMOï¼šã›ã‚„ã‚ã‹ï¼Ÿï¼‰

ææ¡ˆï¼šsessionmakerã§SQLModelã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿”ã•ã›ã‚‹
------------------------------------------------------------

.. code-block:: python
    :emphasize-lines: 4

    from sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine
    from sqlmodel.ext.asyncio.session import AsyncSession as SQLModelAsyncSession

    AsyncSession = async_sessionmaker(engine, class_=SQLModelAsyncSession)

.. https://docs.sqlalchemy.org/en/20/orm/session_basics.html#using-a-sessionmaker

* SQLModelã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãªã®ã§ ``exec()`` ãŒä½¿ãˆã‚‹ï¼
* ç¾çŠ¶ã€ä¸–ã«ã¯SQLAlchemyã®ä¾‹ãŒå¤šã„ã®ã§ã€DBæ¥ç¶šéƒ¨åˆ†ã¯å‚è€ƒã«ã§ãã‚‹

ææ¡ˆã®å‚è€ƒğŸƒâ€â™‚ï¸
------------------------------------------------------------

* å¤§å…ƒ `Add sessionmaker #75 <https://github.com/fastapi/sqlmodel/issues/75#issuecomment-2109911909>`__
* æ‹™ãƒ–ãƒ­ã‚° `SQLModelç´ æŒ¯ã‚Šã®è¨˜ï¼šPostgreSQLã«åŒæœŸæ¥ç¶š ã€œselectã—ã¦è¦‹ãˆãŸã€SQLAlchemyã®sessionmakerã®class_å¼•æ•°ã«ã‚ˆã‚‹ã„ã„ã¨ã“å–ã‚Šæ¡ˆã€œ <https://nikkie-ftnext.hatenablog.com/entry/sqlmodel-postgres-sync-connection-sqlalchemy-sessionmaker-integration>`__
* æ‹™ãƒ–ãƒ­ã‚° `SQLModelã§PostgreSQLã«éåŒæœŸæ¥ç¶šã™ã‚‹å®Ÿè£…ã‚’è€ƒãˆã‚‹ <https://nikkie-ftnext.hatenablog.com/entry/sqlmodel-postgres-async-connection-proposal-sqlalchemy-sessionmaker-integration>`__

IMOï¼šSQLModelæ‰€æ„Ÿ
======================================================================

* SQLModelã§FastAPIã‚¢ãƒ—ãƒªã¯ ``async def`` ã§æ›¸ã‘ã‚‹ãŒã€ã¾ã ã¾ã ç™ºå±•é€”ä¸Šï¼ˆ0.0.22ï¼‰
* **SQLAlchemyã®çµŒé¨“** ãŒã‚ã‚‹æ–¹ã«ã ã‘ã€ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™
* çµŒé¨“ãªã„æˆ‘ãŒèº«ã«ã¯ã€SQLModel + SQLAlchemyã¨ *å­¦ã³ãŒ2å€* ã ã£ãŸğŸ™Œ

IMOï¼šSQLModelã®ç¾çŠ¶ğŸƒâ€â™‚ï¸
--------------------------------------------------

* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯toy exampleã§å®Ÿå‹™ãƒ¬ãƒ™ãƒ«ã®ä¾‹ãŒãªã„ï¼ˆãƒ—ãƒ«ãƒªã‚¯ãƒãƒ£ãƒ³ã‚¹ï¼ï¼‰
* `å…ˆã®æ¯”è¼ƒè¨˜äº‹ <https://www.david-dahan.com/blog/comparing-fastapi-and-django>`__ ã‚ˆã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒ†ãƒŠã‚†ãˆã«åˆ¤æ–­ã‚’èª¤ã£ãŸã®ã§ã¯
* FastAPIãƒ¦ãƒ¼ã‚¶ãŒ **åˆ†æ–­** ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ï¼ˆSQLModelæ¡ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹ãŒè¦‹ã¤ã‹ã‚Šã«ãã„ï¼‰

.. ç©ºæŒ¯ã£ã¦SQLAlchemyã‚’èª¿ã¹ã‚‹
.. order by

.. TODO ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ sqldef
    https://x.com/ftnext/status/1839544709045453293
