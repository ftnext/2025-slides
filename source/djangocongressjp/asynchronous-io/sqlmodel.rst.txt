SQLModel
======================================================================

SQLAlchemy + Pydantic + ä½œè€…tiangoloæ°ã®å·¥å¤«

https://sqlmodel.tiangolo.com/features/

é€Ÿç¿’SQLModelğŸƒâ€â™‚ï¸
--------------------------------------------------

.. raw:: html

    <iframe width="560" height="315" src="https://www.youtube.com/embed/x7qCG9RP7u4?si=_cwx2RHSBf0CZkxL" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

`ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« <https://sqlmodel.tiangolo.com/tutorial/>`__ ã®å†…å®¹ã‚’30åˆ†ã§ã‚«ãƒãƒ¼ã—ã¦ã¾ã™

ã“ã“ã§ã‚‚Pydantic
--------------------------------------------------

* ``SQLModel`` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã¯ã€Pydanticã® ``BaseModel`` ã§ã‚‚ã‚ã‚‹ã®ã§ã€FastAPIã§ä½¿ãˆã‚‹
* ORMã‚’æ‰±ã†éš›ã«ã‚‚ã‚¨ãƒ‡ã‚£ã‚¿ã§è£œå®ŒãŒåŠ¹ã

SQLAlchemy
--------------------------------------------------

* https://github.com/sqlalchemy/sqlalchemy
* ä»£è¡¨çš„ãªORM
* **DBã®éåŒæœŸIO** ã‚’ã‚µãƒãƒ¼ãƒˆï¼

DBã®éåŒæœŸIO
======================================================================

* SQLAlchemyã«SQLModelã¯ä¹—ã£ã‹ã‚‹
* PostgreSQLã®ä¾‹

SQLModelã¨ã—ã¦
--------------------------------------------------

.. code-block:: python

    from sqlalchemy.ext.asyncio import create_async_engine
    from sqlmodel.ext.asyncio.session import AsyncSession

    database_url = "postgresql+asyncpg://developer:mysecretpassword@127.0.0.1:5432/practice"
    engine = create_async_engine(database_url)
    async with AsyncSession(engine) as session:
        ...

IMOï¼š ``async_sessionmaker`` ã¨ã„ã„ã¨ã“å–ã‚Š
--------------------------------------------------

.. code-block:: python

    from sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine
    from sqlmodel.ext.asyncio.session import AsyncSession as SQLModelAsyncSession

    database_url = "postgresql+asyncpg://developer:mysecretpassword@127.0.0.1:5432/practice"
    engine = create_async_engine(database_url)
    AsyncSession = async_sessionmaker(engine, class_=SQLModelAsyncSession)
    async with AsyncSession() as session:  # AsyncSession.begin() ã‚‚ã§ãã‚‹
        ...

SQLModelãŒæä¾›ã™ã‚‹DBã‚»ãƒƒã‚·ãƒ§ãƒ³
--------------------------------------------------

.. code-block:: python

    from sqlmodel import Session
    from sqlmodel.ext.asyncio.session import AsyncSession

* SQLAlchemyã® ``Session`` ã‚„ ``AsyncSession`` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹
* DBã¨ã®ã‚„ã‚Šå–ã‚Šã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é€šã—ã¦ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ *æµ®ã„ã¦ã„ã‚‹* ã‚¤ãƒ¡ãƒ¼ã‚¸

.. revealjs-break::

* ``Session`` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« ``statement`` ã‚’æ¸¡ã—ã¦ã€ ``exec()`` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶
* ğŸ‘‰ **å‹ãŒå½“ãŸã‚‹** ï¼ˆSQLAlchemyã®Sessionã® ``execute().scalars()`` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŸã‚ï¼‰

.. code-block:: python
    :emphasize-lines: 3

    statement = select(Hero)
    async with AsyncSession(async_engine) as session:
        results = await session.exec(statement)
        for hero in results:
            print(repr(hero))

SQLAlchemyãŒæä¾›ã™ã‚‹sessionmaker
--------------------------------------------------

* ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® **ãƒ•ã‚¡ã‚¯ãƒˆãƒª** ã‚’è¿”ã™ã€‚å¸¸ã« ``engine`` ã‚’æ¸¡ã—ã¦åˆæœŸåŒ–ã—ãªãã¦ã‚ˆããªã‚‹
* SQLModelã¯æä¾›ã—ã¦ã„ãªã„ï¼ˆ`tiangoloæ° <https://github.com/fastapi/sqlmodel/issues/75#issuecomment-1311796665>`__ ã€Œå¸¸ã« ``with Session(engine)`` ã™ã‚Œã°ã‚ˆã„ã€ï¼‰
* ãªãŠã€sessionmakerãŒè¿”ã™SQLAlchemyã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ ``exec()`` ã¯ãªãã€ ``execute()`` ã®ã¿ï¼ˆå‹ãŒå½“ãŸã‚‰ãªã„ï¼‰

sessionmakerã‚’ä½¿ã„ãŸã„ç«‹å ´ã‹ã‚‰ã®ææ¡ˆ
--------------------------------------------------

.. code-block:: python
    :emphasize-lines: 4

    from sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine
    from sqlmodel.ext.asyncio.session import AsyncSession as SQLModelAsyncSession

    AsyncSession = async_sessionmaker(engine, class_=SQLModelAsyncSession)

.. https://docs.sqlalchemy.org/en/20/orm/session_basics.html#using-a-sessionmaker

* SQLModelã® ``AsyncSession`` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªã‚’ç”¨æ„ï¼ˆ ``exec()`` ãŒä½¿ãˆã‚‹ï¼ï¼‰
* ç¾çŠ¶ã€ä¸–ã«ã¯SQLAlchemyã®ä¾‹ãŒå¤šã„ã®ã§ã€DBæ¥ç¶šéƒ¨åˆ†ã¯å‚è€ƒã«ã§ãã‚‹

IMOï¼šSQLModelæ‰€æ„Ÿ
======================================================================

* SQLModelã¯ç™ºå±•é€”ä¸Š
* **SQLAlchemyã®çµŒé¨“** ãŒã‚ã‚‹æ–¹ã«ã ã‘ã€ã‚ªã‚¹ã‚¹ãƒ¡
* çµŒé¨“ãªã„æˆ‘ãŒèº«ã«ã¯ã€SQLModel + SQLAlchemyã¨å­¦ã³ãŒ2å€ï¼ˆã—ã‚“ã©ã„ï¼ï¼‰

ç¾çŠ¶ã¯SQLModelã¯ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¥ã‚‰ã„
--------------------------------------------------

* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯toy exampleã§å®Ÿå‹™ãƒ¬ãƒ™ãƒ«ã®ä¾‹ãŒãªã„ï¼ˆãƒ—ãƒ«ãƒªã‚¯ãƒãƒ£ãƒ³ã‚¹ï¼ï¼‰
* å…ˆã®æ¯”è¼ƒè¨˜äº‹ã‚ˆã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒ†ãƒŠã‚†ãˆã«åˆ¤æ–­ã‚’èª¤ã£ãŸã®ã§ã¯
* FastAPIãƒ¦ãƒ¼ã‚¶ãŒ **åˆ†æ–­** ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ï¼ˆSQLModelæ¡ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹ãŒè¦‹ã¤ã‹ã‚Šã«ãã„ï¼‰

.. ç©ºæŒ¯ã£ã¦SQLAlchemyã‚’èª¿ã¹ã‚‹
.. order by

.. TODO ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ sqldef
    https://x.com/ftnext/status/1839544709045453293
