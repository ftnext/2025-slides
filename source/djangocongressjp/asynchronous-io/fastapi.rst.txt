FastAPI
======================================================================

Starlette + Pydantic + ä½œè€…tiangoloæ°ã®å·¥å¤«

https://fastapi.tiangolo.com/features/

encode/starlette
--------------------------------------------------

* https://github.com/encode/starlette
* lightweight ASGI frameworkï¼ˆéåŒæœŸIOã‚µãƒãƒ¼ãƒˆï¼‰
* **é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** ï¼ˆ`Web Framework Benchmarks <https://www.techempower.com/benchmarks/#section=data-r17&hw=ph&test=fortune&l=zijzen-1>`__ 0.18.0æ™‚ç‚¹ï¼‰

.. https://github.com/encode/starlette/tree/0.18.0?tab=readme-ov-file#performance

Pydantic
--------------------------------------------------

* https://github.com/pydantic/pydantic
* å‹ãƒ’ãƒ³ãƒˆã« **ãƒ‘ãƒ¼ã‚¹** ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã€ãƒ­ãƒã‚¹ãƒˆPythonã€ï¼‰
* ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®è£œå®Œã‚„ã€å®Ÿè¡Œæ™‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ‘ã‚¹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã®æ›¸ãæ–¹
======================================================================

.. ç”¨èª https://fastapi.tiangolo.com/tutorial/first-steps/#step-4-define-the-path-operation-function

.. code-block:: python

    @app.get("/sync")
    def root():  # <- path operation function
        return {"message": "Hello World"}

    @app.get("/async")
    async def root():
        return {"message": "ã©ã‚“ãªã¨ãã«async defã«ã™ã‚‹ï¼Ÿ"}

å‡¦ç†ã¯2ç¨®é¡
--------------------------------------------------

* IOãƒã‚¦ãƒ³ãƒ‰

    * å¤–éƒ¨ã¨ã®é€šä¿¡ï¼ˆAPIã‚„DBï¼‰
    * ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ã

* CPUãƒã‚¦ãƒ³ãƒ‰

    * é‡ã„è¨ˆç®—

ãã‚‚ãã‚‚éåŒæœŸIOãŒæœ‰åŠ¹ãªã®ã¯
--------------------------------------------------

* **IOãƒã‚¦ãƒ³ãƒ‰** ãªå‡¦ç†ï¼ˆCPUãƒã‚¦ãƒ³ãƒ‰ã§ã¯ãªã„ï¼‰
* CPUã‚’IOå¾…ã¡ã«ã—ãªã„ã§ä»–ã®å‡¦ç†ã‚’é€²ã‚ã‚‹

FastAPIã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›°ã
--------------------------------------------------

.. https://fastapi.tiangolo.com/async/#in-a-hurry

* éåŒæœŸIOã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ãªã‚‰ã€ãƒ‘ã‚¹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã¯ ``async def``
* ``await`` ãŒä½¿ãˆã‚‹ã®ã¯ ``async def`` ã®ä¸­ã ã‘

.. code-block:: python

    client = AsyncOpenAI()

    @app.get("/async")
    async def use_async_support_library():
        chat_completion = await client.chat.completions.create(...)

.. https://github.com/openai/openai-python?tab=readme-ov-file#async-usage

.. revealjs-break::

* éåŒæœŸIOã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã‚‰ã€ãƒ‘ã‚¹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã¯ ``def``
* ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°IOã§ã¯ ``def``

.. code-block:: python

    @app.get("/sync")
    async def use_blocking_io_library():
        response = requests.get(...)

CPUãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†ã¯
--------------------------------------------------

* ``async def`` â€¼ï¸

    it's better to use ``async def`` unless your path operation functions use code that performs blocking I/O.

.. ã€Œãƒ‘ã‚¹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ãŒãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°IOã‚’ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã‚ãªã„å ´åˆã€``async def`` ãŒã‚ˆã„ã€
    TL;DRã«ã‚ã‚‹ã€éåŒæœŸIOã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ï¼ˆï¼ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°IOï¼‰ -> ``def``
        ã€ŒIf your application (somehow) doesn't have to communicate with anything else and wait for it to respond, use async def.ã€

https://fastapi.tiangolo.com/async/#path-operation-functions

FastAPIã§ã®éåŒæœŸIOğŸ¥Ÿ
--------------------------------------------------

* **éåŒæœŸIOã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦**ã€ãƒ‘ã‚¹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’ ``async def`` ã§æ›¸ã“ã†ï¼
* CPUãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†ã‚‚FastAPIã§ã¯ ``async def`` ã§æ›¸ãã¨ã‚ˆã„ã¨ã®ã“ã¨
