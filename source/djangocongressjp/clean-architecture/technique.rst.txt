çŸ¥è­˜ã‚’ãƒ¬ã‚¤ãƒ¤ã«é–‰ã˜è¾¼ã‚ã‚‹ãŸã‚ã«
======================================================================

å·¥å¤«2ã¤ã‚’å…±æœ‰ï¼ˆè­°è«–ã®ç¨®ã¨ã—ã¦ï¼‰

1ï¸âƒ£FastAPIã®Depends
======================================================================

restå±¤ã§ã“ã‚ŒãŒã‚„ã‚ŠãŸã‹ã£ãŸï¼ˆå†æ²ï¼‰
--------------------------------------------------

.. code-block:: python
    :caption: path operationé–¢æ•°ã« ``use_case`` ã‚’æ³¨å…¥

    def inject_list_books_use_case(
        session: Annotated[type[SQLModelAsyncSession], Depends(get_session)],
    ) -> ListBooksUseCase:
        return ListBooksUseCase(FetchBooksFromDatabase(PostgresqlDatabaseDriver(session)))

    @app.get("/books", response_model=list[BookReadModel])
    async def get_books(
        use_case: Annotated[ListBooksUseCase, Depends(inject_list_books_use_case)],
    ):
        books = await use_case.execute()
        return [BookReadModel.from_book(book) for book in books]

FastAPIã® ``Depends`` ğŸŒŸ
--------------------------------------------------

https://fastapi.tiangolo.com/tutorial/dependencies/

.. code-block:: python

    async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
        return {"q": q, "skip": skip, "limit": limit}

    @app.get("/items/")
    async def read_items(commons: Annotated[dict, Depends(common_parameters)]):
        return commons

``Annotated[..., Depends(...)]``
--------------------------------------------------

* ``typing.Annotated[<type>, <metadata>]`` ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸
* ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã® ``Depends(é–¢æ•°)`` ã¯ã€ **é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦è¿”ã‚Šå€¤ã‚’å‹ãƒ’ãƒ³ãƒˆã—ã¦ã‚‹å¤‰æ•°ã«ä»£å…¥**
* IMOï¼šå‹•ããŒ `pytestã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ <https://nikkie-ftnext.hatenablog.com/entry/sphinx-extension-e2e-app-status-warning-are-pytest-fixtures#pytest%E3%81%AE%E3%83%95%E3%82%A3%E3%82%AF%E3%82%B9%E3%83%81%E3%83%A3%E3%81%AF%E5%BC%95%E6%95%B0%E3%81%AB%E3%81%82%E3%82%8B%E5%88%A5%E3%81%AE%E3%83%95%E3%82%A3%E3%82%AF%E3%82%B9%E3%83%81%E3%83%A3%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%A7%E3%81%8D%E3%82%8B>`__ ã£ã½ã„

Dependsã¯ **é€£é–** ã™ã‚‹â›“ï¸
--------------------------------------------------

https://fastapi.tiangolo.com/tutorial/dependencies/sub-dependencies/

.. code-block:: python

    def query_extractor(q: str | None = None):
        # çœç•¥

    def query_or_cookie_extractor(
        q: Annotated[str, Depends(query_extractor)],
        last_query: Annotated[str | None, Cookie()] = None,
    ):
        # çœç•¥

    @app.get("/items/")
    async def read_query(
        query_or_default: Annotated[str, Depends(query_or_cookie_extractor)],
    ):
        # çœç•¥

``Depends`` ã®é€£é–ã‚’ä½¿ã£ã¦DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ³¨å…¥
--------------------------------------------------

.. code-block:: python
    :caption: restå±¤

    def inject_list_books_use_case(
        session: Annotated[type[SQLModelAsyncSession], Depends(get_session)],
    ) -> ListBooksUseCase:

.. code-block:: python
    :caption: driverå±¤

    async def get_session():
        yield AsyncSession  # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§async_sessionmakerã—ã¦ã„ã‚‹

.. _rhoboro/async-fastapi-sqlalchemy: https://github.com/rhoboro/async-fastapi-sqlalchemy

å‡ºå…¸ã¯ `rhoboro/async-fastapi-sqlalchemy`_
------------------------------------------------------------

* Sub-dependenciesã«åŠ ãˆã¦ `Classes as Dependencies <https://fastapi.tiangolo.com/tutorial/dependencies/classes-as-dependencies/>`__

.. code-block:: python
    :caption: `views.py <https://github.com/rhoboro/async-fastapi-sqlalchemy/blob/12683934b451c76af5eea7ee5bf4e6c8342ca165/app/api/notes/views.py#L27-L31>`__ æŠœç²‹

    @router.get("")
    async def read_all(
        use_case: ReadAllNote = Depends(ReadAllNote),
    ) -> ReadAllNoteResponse:

.. revealjs-break::
    :notitle:

.. code-block:: python
    :caption: `use_cases.py <https://github.com/rhoboro/async-fastapi-sqlalchemy/blob/12683934b451c76af5eea7ee5bf4e6c8342ca165/app/api/notes/use_cases.py#L22-L24>`__ æŠœç²‹

    class ReadAllNote:
        def __init__(self, session: AsyncSession) -> None:
            self.async_session = session

.. code-block:: python
    :caption: `db.py <https://github.com/rhoboro/async-fastapi-sqlalchemy/blob/12683934b451c76af5eea7ee5bf4e6c8342ca165/app/db.py#L24-L31>`__ æŠœç²‹

    async def get_session() -> AsyncIterator[async_sessionmaker]:
        ...

    AsyncSession = Annotated[async_sessionmaker, Depends(get_session)]

FastAPIã® ``Depends`` ã¯ç©æ¥µçš„ã«æ´»ç”¨ã§ããªã„
--------------------------------------------------

* **ãƒ¬ã‚¤ãƒ¤åˆ†ã‘** ã‚’å„ªå…ˆã™ã‚‹ã¨ã€ ``Depends`` ã¯ domain ã‚„ usecase ã«ã¯å‹ãƒ’ãƒ³ãƒˆã§ããªã„ï¼ˆFastAPIã¯restå±¤ã®æŠ€è¡“è©³ç´°ï¼‰
* FastAPIã¯ ``Depends`` ã‚’ä½¿ã„å€’ã—ãŸæ–¹ãŒé–‹ç™ºè€…ã¯æ¥½ãŒã§ããã†ï¼ˆå·®ã—æ›¿ãˆå¯èƒ½ã‚ˆã‚Šå„ªå…ˆã™ã‚‹åˆ¤æ–­ã‚‚ã‚ã‚Šå¾—ã‚‹ï¼‰

2ï¸âƒ£æ‹¡å¼µé–¢æ•°ã‚’å¿—å‘ã™ã‚‹
======================================================================

æ‹¡å¼µé–¢æ•°ï¼ˆä¾‹ï¼šKotlinï¼‰
--------------------------------------------------

* ç¶™æ‰¿ã—ãªãã¦ã‚‚ã‚¯ãƒ©ã‚¹ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã§ãã‚‹
* https://kotlinlang.org/docs/extensions.html

æ‹¡å¼µã™ã‚‹ä¾‹
--------------------------------------------------

.. code-block:: kotlin
    :caption: ``MutableList<Int>`` ã« ``swap`` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

    fun MutableList<Int>.swap(index1: Int, index2: Int) {
        val tmp = this[index1] // 'this' corresponds to the list
        this[index1] = this[index2]
        this[index2] = tmp
    }

``MutableList`` ã¯collectionã®1ã¤

ãƒ¬ã‚¤ãƒ¤åˆ†ã‘ã«ãŠã‘ã‚‹æ‹¡å¼µé–¢æ•°ã®å‡ºç•ª
------------------------------------------------

* gatewayå±¤ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã®å‹ã¨ã€å¤–ç•Œã®å‹ï¼ˆè¨€èªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªå‹ï¼‰ã® **å¤‰æ›**
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã€DBã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‹ï¼ˆåŒå¿ƒå††ã®å¤–å´ï¼‰ã‚’çŸ¥ã‚Šå¾—ãªã„

gatewayã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ‹¡å¼µã™ã‚‹æ¡ˆ
------------------------------------------------

.. code-block:: python

    def books_from_records(book_records: list[BookRecord]) -> Books:
        return Books(...)
    
    Books.from_ = staticmethod(books_from_records)  # type: ignore[attr-defined]

gatewayã«ãŠã‘ã‚‹Booksãƒ‰ãƒ¡ã‚¤ãƒ³ã« ``from_()`` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œæ™‚ã«ç”Ÿã‚„ã—ãŸ

Pythonç‰ˆ *æ‹¡å¼µé–¢æ•°*
------------------------------------------------

* ãƒ¬ã‚¤ãƒ¤é–“ã®é–¢å¿ƒã®åˆ†é›¢ã¯é”æˆï¼
* **å®Ÿè³ªã¯ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°** ã€‚å‹ãƒã‚§ãƒƒã‚¯ã§æ€’ã‚‰ã‚Œã€ã‚³ãƒ¼ãƒ‰ã‚¸ãƒ£ãƒ³ãƒ—ã«å½±éŸ¿

ä»–ã®æ–¹æ³•ã¯ä»Šã¯æµ®ã‹ã‚“ã§ã„ã¾ã›ã‚“...
