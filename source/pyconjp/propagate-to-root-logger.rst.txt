.. _propagate: https://docs.python.org/ja/3/library/logging.html#logging.Logger.propagate

Chapter 3: ルートロガーでロギングしよう - propagate（伝播）
======================================================================

ロガーの親子関係で重要なものは、``NOTSET`` レベルの他にもう1つ

ロガーの `propagate`_ 属性
======================================================================

    この属性が真と評価された場合、このロガーに記録されたイベントは、このロガーに取り付けられた全てのハンドラに加え、上位 (祖先) ロガーのハンドラにも渡されます。

``getLogger`` すると ``propagate`` は ``True``
------------------------------------------------------------

.. code-block:: pycon

    >>> import logging
    >>> httpx_logger = logging.getLogger("httpx")
    >>> httpx_logger.propagate
    True

ロガーの親子関係（再び）
--------------------------------------------------

.. image:: ../_static/pyconjp/pyconjp-logger-ancestors-part.drawio.png
    :scale: 120%

propagate（伝播）
--------------------------------------------------

* ``httpx`` ロガーのロギングレベル以上のメソッドが呼ばれた
* そのログレコードは **親のルートロガーに伝播** し、親のハンドラにも渡る

📌伝播では **親ロガーのレベル・フィルタは見ない**
--------------------------------------------------

TODO ロギングフロー

💡ルートロガーにハンドラをつければロギングできる！
======================================================================

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_hard.py
    :language: python
    :lines: 13-21
    :emphasize-lines: 1,4,9

ハンドラにフォーマッタをとりつけ
--------------------------------------------------

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_hard.py
    :language: python
    :lines: 13-21
    :emphasize-lines: 4-8

**全て** のロガーのログ出力
--------------------------------------------------

.. literalinclude:: all-logger-log.txt

多い出力には、フィルタ
--------------------------------------------------

* （ルートロガーではなく）ハンドラにフィルタを設定
* ``httpx`` ロガーによるログだけを出力

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_hard.py
    :language: python
    :lines: 22

なぜハンドラにフィルタをつける？
--------------------------------------------------

.. TODO よりわかりやすくできそう

* ロギングフローより、子のロガーから親のルートロガーに伝播
* このとき、**ルートロガーのフィルタは確認されない**
* ルートロガーのハンドラのフィルタは確認される

ルートロガーでロギングの例
======================================================================

例1️⃣ ルートロガーに複数ハンドラ
--------------------------------------------------

「``INFO`` 以上はファイルにロギング、``ERROR`` 以上はコンソールにも出力」

* ``ERROR`` レベルの ``StreamHandler``
* ``INFO`` レベルの ``FileHandler``

``DEBUG`` 以上をファイルに、``INFO`` 以上をコンソールに
------------------------------------------------------------

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_multi_handlers.py
    :language: python
    :lines: 14-31

``DEBUG`` 以上をファイルに
------------------------------------------------------------

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_multi_handlers.py
    :language: python
    :lines: 14-31
    :emphasize-lines: 9-13

``INFO`` 以上をコンソールに
------------------------------------------------------------

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_multi_handlers.py
    :language: python
    :lines: 14-31
    :emphasize-lines: 5-7

例2️⃣ JSONフォーマッタ
--------------------------------------------------

* ルートロガーのハンドラのフォーマッタを **JSON出力する** ものに差し替えるだけ
* `python-json-logger <https://github.com/nhairs/python-json-logger>`__ の ``JsonFormatter``

.. https://nikkie-ftnext.hatenablog.com/entry/python-json-logger-formatter-for-json-logging-quickstart

``JsonFormatter`` に差し替え
--------------------------------------------------

.. literalinclude:: ../../samplecode/python-logging/library_logger/root_logging_jsonformat.py
    :language: python
    :lines: 12,14-24
    :emphasize-lines: 7

.. code-block:: json

    {"asctime": "2025-09-25 00:27:41,332", "levelname": "INFO", "name": "httpx", "filename": "_client.py", "funcName": "_send_single_request", "lineno": 1025, "message": "HTTP Request: GET https://peps.python.org/api/peps.json \"HTTP/1.1 200 OK\""}

全てアプリケーションコードの話
--------------------------------------------------

* ルートロガーを設定するのは、アプリケーションコード（＝ライブラリの利用者のコード）
* ライブラリの作者は、ロギングのフォーマットや出力先には関心がない（**ルートロガーは触りません！**）

.. ライブラリまで行かなくても、自分が書くコードでもこれが当てはまることを伝えたい（論文の公開コード）
